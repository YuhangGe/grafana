<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width">
  <meta name="theme-color" content="#000">

  <title>HanSight NTAS - 登陆</title>

  <!--if DEBUG -->
  <script src="__liveload.js"></script>
  <link href='/css/fonts.css' rel='stylesheet' type='text/css'>
  <link href="/css/grafana.dark.css" rel="stylesheet" type="text/css">
  <!--else -->
  <link href='/css/fonts.min.css' rel='stylesheet' type='text/css'>
  <link href="/css/grafana.dark.min.css" rel="stylesheet" type="text/css">
  <!-- end if -->

  <link rel="icon" type="image/png" href="/img/fav32.png">
  <base href="/" />

</head>

<body>
<div class="login-container container">

  <div class="login-box">

    <div class="login-box-logo">
      <img class="logo-icon" src="/img/han_sight_logo.png"/><br>
      <!--<i class="icon-gf icon-gf-grafana_wordmark"></i>-->
      <span class="icon-gf-grafana_wordmark">瀚思网络流量分析系统</span>
    </div>

    <div class="login-inner-box">
      <div class="login-tab-header">
        <button class="btn-login-tab active">
          登录
        </button>
        <button class="btn-login-tab">
          帮助
        </button>
      </div>

      <form name="loginForm" class="login-form gf-form-group">
        <p id="error-tip" class="error-tip"></p>
        <div class="gf-form">
          <span class="gf-form-label width-7">用户名</span>
          <input type="text" name="username" id="username" class="gf-form-input max-width-14">
        </div>
        <div class="gf-form">
          <span class="gf-form-label width-7">密码</span>
          <input type="password" name="password" id="password" class="gf-form-input max-width-14">
        </div>

        <div class="gf-form-button-row">
          <button type="button" id="submit" class="btn btn-large p-x-3 btn-primary">
            登录
          </button>
        </div>
      </form>

      <form name="helpForm" style="display: none; min-height: 148px" class="login-form gf-form-group">
        <p class="help-tip">
          请联系管理员注册用户名和密码
        </p>
      </form>

      <div class="clearfix"></div>

      <div class="text-center password-recovery">
        <div class="text-center">
          忘记密码请联系管理员找回
        </div>
      </div>
    </div>

    <div class="row" style="margin-top: 50px">
      <div class="version-footer text-center small">
        瀚思版权所有
      </div>
    </div>
  </div>
</div>
</body>
<script type="text/javascript">
  (function () {
    function getBody(data) {
      if (!data) {
        return null;
      }
      var body = [];
      for(var k in data) {
        body.push(encodeURIComponent(k) + '=' + encodeURIComponent(data[k]));
      }
      return body.join('&');
    }
    function request(url, opts) {
      return new Promise(function (resolve, reject) {
        opts = opts || {};
        var http = new XMLHttpRequest();
        http.open(opts.method || 'GET', url, !opts.async);
        http.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
        http.onreadystatechange = function () {
          if (http.readyState === 4) {
            if (http.status === 200 || http.status === 401) {
              try {
                resolve(JSON.parse(http.responseText));
              } catch(ex) {
                reject(ex);
              }
            } else {
              console.log(http.status, http.statusText);
              reject(http.statusText);
            }
          }
        };
        http.send(getBody(opts.data));
      });
    }

    function $(id) {
      return document.getElementById(id);
    }

    var $submit = $('submit');
    var $name = $('username');
    var $pass = $('password');
    var $tip = $('error-tip');
    $submit.addEventListener('click', login);
    var $tbs = document.querySelectorAll('.login-tab-header .btn-login-tab');
    var $fms = document.querySelectorAll('form');
    [].forEach.call($tbs, function ($btn, i) {
      $btn.addEventListener('click', function () {
        tab(i);
      });
    });

    function tab(i) {
      $tbs[0].className = 'btn-login-tab' + (i=== 0 ? ' active' : '');
      $tbs[1].className = 'btn-login-tab' + (i=== 1 ? ' active' : '');
      $fms[0].style.display = i === 0 ? 'inline-block' : 'none';
      $fms[1].style.display = i === 1 ? 'inline-block' : 'none';
    }

    function tip(err) {
      $tip.textContent = err;
      $tip.style.display = 'block';
    }
    function login() {
      var name = $name.value.trim();
      if (!name) {
        tip('用户名不能为空!');
        return;
      }
      var pass = $pass.value;
      if (!pass) {
        tip('密码不能为空!');
        return;
      }
      request('/login', {
        method: 'POST',
        data: {
          password: pass,
          user: name
        }
      }).then(function (res) {
        if (res.message === 'Logged in') {
          var m = location.href.match(/url=(.+)/);
          location.href = m ? decodeURIComponent(m[1]) : '/';
        } else {
          tip('用户名或密码错误');
        }
      }, function () {
        tip('网络错误，请重试。');
      })
    }
  })();
</script>
</html>
